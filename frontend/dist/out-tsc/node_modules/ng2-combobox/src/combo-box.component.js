var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
import { Component, Input, Output, EventEmitter, forwardRef, ViewChild } from '@angular/core';
import { Observable } from 'rxjs/Rx';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
export var ComboBoxComponent = (function () {
    function ComboBoxComponent() {
        this.remote = false;
        this.clearOnSelect = false;
        this.forceSelection = true;
        this.localFilter = false;
        this.localFilterCaseSensitive = true;
        this.typeAheadDelay = 500;
        this.inputClass = 'form-control';
        this.inputPlaceholder = '';
        this.loadingIconClass = 'loader';
        this.triggerIconClass = 'trigger';
        this.dataRoot = '';
        this.disabledField = null;
        this.editable = true;
        this.noMatchesText = '';
        this.onQuery = new EventEmitter();
        this.onSelect = new EventEmitter();
        this.onCreate = new EventEmitter();
        this.onBlur = new EventEmitter();
        this.onInitValue = new EventEmitter();
        this.hideList = true;
        this._loading = false;
        this._marked = null;
        this._hasFocus = false;
        this._enterCued = false;
        this._noBlur = false;
        // ControlValueAccessor props
        this.propagateTouch = function () {
        };
        this.propagateChange = function (_) {
        };
    }
    ComboBoxComponent.prototype.ngOnInit = function () {
    };
    Object.defineProperty(ComboBoxComponent.prototype, "listData", {
        set: function (value) {
            var _this = this;
            if (this._listDataSubscription) {
                this._listDataSubscription.unsubscribe();
            }
            if (value instanceof Observable) {
                var listData = value;
                this._listDataSubscription = listData.subscribe(function (data) {
                    // todo: make dataRoot work for all depths
                    if (_this.dataRoot) {
                        data = data[_this.dataRoot];
                    }
                    _this.data = _this._initialData = data;
                    _this.loading = false;
                    if (0 === _this._tmpVal || _this._tmpVal) {
                        _this.writeValue(_this._tmpVal);
                    }
                });
            }
            else {
                var data = value;
                this.data = this._initialData = data;
                this.loading = false;
                // If the list data change, trigger a reprocessing.
                this.loadData();
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ComboBoxComponent.prototype, "currVal", {
        get: function () {
            return this._currVal;
        },
        set: function (value) {
            this._currVal = value;
            this._tmpVal = null;
            this.marked = null;
            this.hideList = !this._hasFocus && !this._noBlur;
            clearTimeout(this._aheadTimer);
            if (!this._currVal) {
                this.sendModelChange(null);
            }
            this._aheadTimer = setTimeout(this.loadData.bind(this), this.typeAheadDelay);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ComboBoxComponent.prototype, "marked", {
        get: function () {
            return this._marked;
        },
        // todo: scroll marked into view
        set: function (value) {
            if (null === value) {
                this._marked = value;
            }
            else if (this.data && 0 <= value && this.data.length >= value - 1) {
                this._marked = value;
                // use private var to prevent query trigger
                this._currVal = this.getDisplayValue(this.data[this._marked]);
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ComboBoxComponent.prototype, "loading", {
        get: function () {
            return this._loading;
        },
        set: function (loading) {
            this._loading = loading;
            if (!loading && this._enterCued) {
                this._enterCued = false;
                this.handleEnter();
            }
        },
        enumerable: true,
        configurable: true
    });
    ComboBoxComponent.prototype.onKeyDown = function (event) {
        var code = event.which || event.keyCode;
        switch (code) {
            case 13:
                event.preventDefault();
                this.handleEnter();
                break;
            case 38:
                this.handleUp();
                break;
            case 40:
                this.handleDown();
                break;
            default:
                if (!this.editable) {
                    event.preventDefault();
                    event.stopImmediatePropagation();
                    return false;
                }
                break;
        }
    };
    ComboBoxComponent.prototype.onItemClick = function (index, item) {
        if (this.isDisabled(item)) {
            return;
        }
        this._noBlur = false;
        this.marked = index;
        this.onSelect.emit(this.data[this.marked]);
        this.sendModelChange(this.data[this.marked]);
        if (this.clearOnSelect) {
            this.clear();
        }
        else {
            this.hideList = true;
        }
        if (!this.remote && !this.localFilter) {
            this.data = this._initialData;
        }
    };
    ComboBoxComponent.prototype.onFieldBlur = function (event) {
        var _this = this;
        this._hasFocus = false;
        if (this._noBlur) {
            return;
        }
        this.onBlur.emit(event);
        // timeout for hide to catch click event on list :-(
        setTimeout(function () {
            _this.handleEnter();
        }, 200);
        this.propagateTouch();
    };
    ComboBoxComponent.prototype.onFieldFocus = function () {
        this._hasFocus = true;
        this.hideList = false;
        if (!this.editable) {
            this.clear();
        }
        this.loadData();
    };
    ComboBoxComponent.prototype.onMouseEnterList = function () {
        this._noBlur = true;
    };
    ComboBoxComponent.prototype.onMouseLeaveList = function () {
        this._noBlur = false;
    };
    ComboBoxComponent.prototype.isMarked = function (value) {
        if (null === this.marked) {
            return false;
        }
        return this.data[this.marked] === value;
    };
    ComboBoxComponent.prototype.isDisabled = function (value) {
        if (!this.disabledField) {
            return false;
        }
        return !!value[this.disabledField];
    };
    ComboBoxComponent.prototype.handleEnter = function () {
        if (!this.loading) {
            // try to determine marked (look if item is in list)
            if (!this.marked) {
                for (var i = 0; i < this.data.length; i++) {
                    if (this.currVal === this.getDisplayValue(this.data[i])) {
                        this.marked = i;
                        break;
                    }
                }
            }
            if (null === this.marked) {
                if (this.forceSelection) {
                    this.onSelect.emit(null);
                    this.sendModelChange(null);
                    this.clear();
                }
                else {
                    this.onCreate.emit(this.currVal);
                    //this may causes error
                    this.sendModelChange(this.currVal);
                }
            }
            else {
                var item = this.data[this.marked];
                if (this.isDisabled(item)) {
                    return;
                }
                this.onSelect.emit(this.data[this.marked]);
                this.sendModelChange(this.data[this.marked]);
            }
            if (this.clearOnSelect) {
                this.clear();
            }
            else {
                this.hideList = true;
            }
            if (!this.remote && !this.localFilter) {
                this.data = this._initialData;
            }
        }
        else {
            this._enterCued = true;
        }
    };
    ComboBoxComponent.prototype.handleUp = function () {
        if (this.marked) {
            this.marked--;
        }
    };
    ComboBoxComponent.prototype.handleDown = function () {
        if (null !== this.marked) {
            this.marked++;
        }
        else {
            this.marked = 0;
        }
    };
    ComboBoxComponent.prototype.clear = function () {
        this.currVal = '';
        this.data = [];
    };
    ComboBoxComponent.prototype.getDisplayValue = function (val) {
        var result = val;
        if (!this.displayField || !val) {
            return null;
        }
        this.displayField.split('.').forEach(function (index) {
            result = result[index];
        });
        return result;
    };
    ComboBoxComponent.prototype.getValueValue = function (val) {
        var result = val;
        if (!this.valueField || !val) {
            return val;
        }
        this.valueField.split('.').forEach(function (index) {
            result = result[index];
        });
        return result;
    };
    ComboBoxComponent.prototype.loadData = function () {
        var _this = this;
        if (!this.remote) {
            if (this.localFilter) {
                this.data = this._initialData.filter(function (item) {
                    if (!_this.currVal) {
                        return true;
                    }
                    else {
                        if (_this.localFilterCaseSensitive) {
                            return -1 !== _this.getDisplayValue(item).indexOf(_this.currVal);
                        }
                        else {
                            return -1 !== _this.getDisplayValue(item).toLowerCase().indexOf(_this.currVal.toLowerCase());
                        }
                    }
                });
            }
        }
        else {
            this.loading = true;
            this.onQuery.emit(this._currVal);
        }
    };
    ComboBoxComponent.prototype.sendModelChange = function (val) {
        this.propagateChange(this.getValueValue(val));
    };
    ComboBoxComponent.prototype.searchValueObject = function (value) {
        var _this = this;
        if (false === value instanceof Object && this.valueField && this._initialData) {
            this._initialData.forEach(function (item) {
                if (value === _this.getValueValue(item)) {
                    value = item;
                }
            });
        }
        return value;
    };
    ComboBoxComponent.prototype.onTriggerClick = function () {
        this._input.nativeElement.focus();
    };
    ComboBoxComponent.prototype.writeValue = function (value) {
        value = this.searchValueObject(value);
        if (value instanceof Object && this.getDisplayValue(value)) {
            this.currVal = this.getDisplayValue(value);
        }
        else {
            this._tmpVal = value;
        }
        this.onInitValue.emit(value);
    };
    ComboBoxComponent.prototype.registerOnChange = function (fn) {
        this.propagateChange = fn;
    };
    ComboBoxComponent.prototype.registerOnTouched = function (fn) {
        this.propagateTouch = fn;
    };
    __decorate([
        Input(), 
        __metadata('design:type', String)
    ], ComboBoxComponent.prototype, "displayField", void 0);
    __decorate([
        Input(), 
        __metadata('design:type', String)
    ], ComboBoxComponent.prototype, "valueField", void 0);
    __decorate([
        Input(), 
        __metadata('design:type', Boolean)
    ], ComboBoxComponent.prototype, "remote", void 0);
    __decorate([
        Input(), 
        __metadata('design:type', Boolean)
    ], ComboBoxComponent.prototype, "clearOnSelect", void 0);
    __decorate([
        Input(), 
        __metadata('design:type', Boolean)
    ], ComboBoxComponent.prototype, "forceSelection", void 0);
    __decorate([
        Input(), 
        __metadata('design:type', Boolean)
    ], ComboBoxComponent.prototype, "localFilter", void 0);
    __decorate([
        Input(), 
        __metadata('design:type', Boolean)
    ], ComboBoxComponent.prototype, "localFilterCaseSensitive", void 0);
    __decorate([
        Input(), 
        __metadata('design:type', Number)
    ], ComboBoxComponent.prototype, "typeAheadDelay", void 0);
    __decorate([
        Input(), 
        __metadata('design:type', String)
    ], ComboBoxComponent.prototype, "inputClass", void 0);
    __decorate([
        Input(), 
        __metadata('design:type', String)
    ], ComboBoxComponent.prototype, "inputPlaceholder", void 0);
    __decorate([
        Input(), 
        __metadata('design:type', String)
    ], ComboBoxComponent.prototype, "loadingIconClass", void 0);
    __decorate([
        Input(), 
        __metadata('design:type', String)
    ], ComboBoxComponent.prototype, "triggerIconClass", void 0);
    __decorate([
        Input(), 
        __metadata('design:type', String)
    ], ComboBoxComponent.prototype, "dataRoot", void 0);
    __decorate([
        Input(), 
        __metadata('design:type', String)
    ], ComboBoxComponent.prototype, "disabledField", void 0);
    __decorate([
        Input(), 
        __metadata('design:type', Boolean)
    ], ComboBoxComponent.prototype, "editable", void 0);
    __decorate([
        Input(), 
        __metadata('design:type', String)
    ], ComboBoxComponent.prototype, "noMatchesText", void 0);
    __decorate([
        Output(), 
        __metadata('design:type', Object)
    ], ComboBoxComponent.prototype, "onQuery", void 0);
    __decorate([
        Output(), 
        __metadata('design:type', Object)
    ], ComboBoxComponent.prototype, "onSelect", void 0);
    __decorate([
        Output(), 
        __metadata('design:type', Object)
    ], ComboBoxComponent.prototype, "onCreate", void 0);
    __decorate([
        Output(), 
        __metadata('design:type', Object)
    ], ComboBoxComponent.prototype, "onBlur", void 0);
    __decorate([
        Output(), 
        __metadata('design:type', Object)
    ], ComboBoxComponent.prototype, "onInitValue", void 0);
    __decorate([
        ViewChild('inputField'), 
        __metadata('design:type', Object)
    ], ComboBoxComponent.prototype, "_input", void 0);
    __decorate([
        Input(), 
        __metadata('design:type', Object), 
        __metadata('design:paramtypes', [Object])
    ], ComboBoxComponent.prototype, "listData", null);
    __decorate([
        Input(), 
        __metadata('design:type', String), 
        __metadata('design:paramtypes', [String])
    ], ComboBoxComponent.prototype, "currVal", null);
    ComboBoxComponent = __decorate([
        Component({
            moduleId: 'ng2-combobox',
            selector: 'combo-box',
            template: "\n        <div class=\"field-wrap\">\n            <input #inputField class=\"{{inputClass}}\" type=\"text\" placeholder=\"{{inputPlaceholder}}\"\n                   [(ngModel)]=\"currVal\"\n                   (keydown)=\"onKeyDown($event)\"\n                   (blur)=\"onFieldBlur($event)\"\n                   (focus)=\"onFieldFocus()\">\n        \n            <div class=\"icons\">\n                <i *ngIf=\"loading\" class=\"{{loadingIconClass}}\"></i>\n                <i *ngIf=\"!loading\" (click)=\"onTriggerClick()\" class=\"{{triggerIconClass}}\"></i>\n            </div>\n        \n            <div class=\"list\" *ngIf=\"data && !hideList\" (mouseenter)=\"onMouseEnterList($event)\" (mouseleave)=\"onMouseLeaveList($event)\">\n                <div class=\"no-matches\" *ngIf=\"noMatchesText && data.length == 0\">{{noMatchesText}}</div>\n                <div *ngFor=\"let item of data;let index = index;\"\n                     [ngClass]=\"{'item': true, 'marked': isMarked(item), 'disabled': isDisabled(item)}\"\n                     (click)=\"onItemClick(index, item)\">\n                    {{getDisplayValue(item)}}\n                </div>\n            </div>\n        </div>\n    ",
            styles: ["\n        .field-wrap {\n            position: relative;\n        }\n                \n        .list {\n            position: absolute;\n            width: 100%;\n            height: auto;\n            background-color: white;\n            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);\n            z-index: 9999;\n            max-height: 200px;\n            overflow: auto;\n        }\n        \n        .list .no-matches {\n            padding: 10px 20px;\n            cursor: default;\n            user-select: none;\n            font-style: italic;\n        }\n\n        .list .item {\n            padding: 10px 20px;\n            cursor: pointer;\n        }\n        \n        .list .item.marked,\n        .list .item:hover{\n            background-color: #ecf0f5;\n        }\n        \n        .list .item.marked {\n            font-weight: bold;\n        }\n        \n        .list .item.disabled {\n            opacity: .5;\n        }\n        \n        .icons {\n            position: absolute;\n            right: 8px;\n            top: 0px;\n            height: 100%;\n        }\n        \n        .icons i {\n            height: 20px;\n            width: 20px;\n            position: absolute;\n            top: 0;\n            bottom: 0;\n            left: 0;\n            right: 0;\n            margin: auto auto auto -20px;\n        }\n        \n        .loader {\n            background-image: url('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB3aWR0aD0nMzhweCcgaGVpZ2h0PSczOHB4JyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJ4TWlkWU1pZCIgY2xhc3M9InVpbC1yZWxvYWQiPgogICAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9Im5vbmUiIGNsYXNzPSJiayI+PC9yZWN0PgogICAgPGc+CiAgICAgICAgPHBhdGggZD0iTTUwIDE1QTM1IDM1IDAgMSAwIDc0Ljc4NyAyNS4yMTMiIGZpbGw9Im5vbmUiIHN0cm9rZT0icmdiYSgzOCwzOCwzOCwwLjkzKSIgc3Ryb2tlLXdpZHRoPSIxMnB4Ij48L3BhdGg+CiAgICAgICAgPHBhdGggZD0iTTUwIDBMNTAgMzBMNjYgMTVMNTAgMCIgZmlsbD0icmdiYSgzOCwzOCwzOCwwLjkzKSI+PC9wYXRoPgogICAgICAgIDxhbmltYXRlVHJhbnNmb3JtIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgdHlwZT0icm90YXRlIiBmcm9tPSIwIDUwIDUwIiB0bz0iMzYwIDUwIDUwIiBkdXI9IjFzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSI+PC9hbmltYXRlVHJhbnNmb3JtPgogICAgPC9nPgo8L3N2Zz4=');\n            background-size: cover;\n        }\n        \n        .trigger {\n            background-size: contain;\n            background-repeat: no-repeat;\n            background-position: center center;\n            background-image: url(\"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjxzdmcgdmVyc2lvbj0iMS4xIiBpZD0iRWJlbmVfM19Lb3BpZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeD0iMHB4Ig0KCSB5PSIwcHgiIHZpZXdCb3g9IjAgMCA1OSAzMS45IiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1OSAzMS45OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+DQo8c3R5bGUgdHlwZT0idGV4dC9jc3MiPg0KCS5zdDB7ZmlsbDpub25lO3N0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxLjU7c3Ryb2tlLW1pdGVybGltaXQ6MTA7fQ0KPC9zdHlsZT4NCjxwb2x5bGluZSBjbGFzcz0ic3QwIiBwb2ludHM9IjU3LjYsMS44IDI5LjUsMjkuOCAyOS41LDI5LjggMS41LDEuOCAiLz4NCjwvc3ZnPg0K\");\n            cursor: pointer;\n        }\n\n        input::-ms-clear {\n            display:none;\n        }\n    "],
            providers: [{
                    provide: NG_VALUE_ACCESSOR,
                    useExisting: forwardRef(function () { return ComboBoxComponent; }),
                    multi: true
                }]
        }), 
        __metadata('design:paramtypes', [])
    ], ComboBoxComponent);
    return ComboBoxComponent;
}());
//# sourceMappingURL=/Users/peterjames/workspace/Forum/frontend/src/node_modules/ng2-combobox/src/combo-box.component.js.map